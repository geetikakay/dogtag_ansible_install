- name: vars
  include_vars: "{{ item }}"
  with_items:
  - "{{ playbook_dir }}/vars/ldap_shared.yml"
  - "{{ playbook_dir }}/vars/ca_shared.yml"
  when: topology  == "topology-01"

- name: vars
  include_vars: "{{ item }}"
  with_items:
  - "{{ playbook_dir }}/vars/ldap.yml"
  - "{{ playbook_dir }}/vars/ca.yml"
  when: topology  == "topology-02"

- name: Copying templates to /tmp folder
  copy : src=test/  dest=/tmp/
  tags: platform-ci

- name: Replace  Ldap server port in all configuration files 
  replace: dest={{item}} regexp="ldapServerPort" replace={{ldapServerPort}}
  with_items:
  - /tmp/ldap.cfg
  - /tmp/ca.cfg
  - /tmp/kra.cfg
  - /tmp/ocsp.cfg
  - /tmp/tks.cfg
  
- name: Replace ServerName in all configuration files.
  replace: dest={{item}} regexp="SERVERNAME" replace={{ansible_fqdn}}
  with_items:
  - /tmp/ldap.cfg
  - /tmp/ca.cfg

- name: Replace topology in use in all configuration files
  replace: dest={{item}} regexp="topology" replace={{topology}}
  with_items:
  - /tmp/ldap.cfg
  - /tmp/ca.cfg

- name: Replace CA specific changes 
  replace: dest=/tmp/ca.cfg regexp="capki_https_port" replace={{capki_https_port}}

- name: Replace http port for CA.
  replace: dest=/tmp/ca.cfg regexp="capki_http_port" replace={{capki_http_port}}

- name: Replace ajp port for CA
  replace: dest=/tmp/ca.cfg regexp="capki_ajp_port" replace={{capki_ajp_port}}

- name : Replace tomcat port for CA
  replace: dest=/tmp/ca.cfg regexp="capki_tomcat_server_port" replace={{capki_tomcat_server_port}}

- name: Setup DS Service
  shell: setup-ds.pl --silent --file=/tmp/ldap.cfg

- name: Install CA master
  shell: pkispawn -s CA -f /tmp/ca.cfg
